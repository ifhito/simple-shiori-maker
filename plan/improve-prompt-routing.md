# Plan: プロンプト文改善 — 移動効率と訪問地の厳守

## Context

しおりアプリのプロンプト生成において、現状のLLMへの指示が「行きたい場所を反映する」程度の曖昧な表現にとどまっていた。これにより：
- 「絶対に行きたい場所」がスケジュールに含まれないケースがある
- 各スポットの地理的位置を考慮せず、移動が非効率なルートになる

ユーザーの要望：
1. **移動効率** — 各スポットの地理的位置（エリア）を考慮し、近いスポット同士をまとめ、無駄な移動（バックトラック）を防ぐ
2. **訪問地の厳守** — 「絶対に行きたい場所」に挙げたスポットは必ずすべてスケジュールに含める

## ブランチ

```
feat/improve-prompt-routing
```

## 変更ファイル

### 1. `src/application/usecases/generatePrompt.ts`

プロンプト冒頭の役割説明を強化：

```
変更前:
あなたは旅行プランナーです。以下の条件で旅行しおりデータを作成してください。

変更後:
あなたは地理情報を熟知した旅行プランナーです。以下の条件で旅行しおりデータを作成してください。
「絶対に行きたい場所」は必ずすべてスケジュールに組み込み、スポット間の地理的な位置関係を考慮して移動効率の高いルートを組んでください。
```

出力ルール（旧 rule 7 を分割・強化し、旧 8〜14 を 10〜16 に繰り下げ）：

```
変更前:
7. 旅行条件メモの優先度や希望内容を反映する。

変更後:
7. 旅行条件メモの「絶対に行きたい場所」に挙げたスポットはすべて items に含める。1か所でも欠落した場合、出力は無効とみなす。
8. 各スポットの所在エリア・地区を考慮し、地理的に近いスポット同士を同じ時間帯・連続する時間枠に配置する。無駄な往復（バックトラック）を避け、移動が最短になる順序でスケジュールを組む。
9. 移動時間が長くなる場合は item として「移動」を明示し、description に手段と所要時間の目安を記載する。
（旧 8〜14 → 10〜16 に繰り下げ）
```

### 2. `src/application/usecases/generatePrompt.test.ts`

新しいルール文言に合わせてテストケースを4件追加：
- 「絶対に行きたい場所」の厳守ルール文言がプロンプトに含まれることを確認
- 移動効率・バックトラック回避の文言がプロンプトに含まれることを確認
- 長距離移動を `items` に明示するルール文言を確認
- 役割説明（地理情報を熟知した旅行プランナー）の文言を確認

### 3. `src/presentation/components/PromptForm.tsx` の REQUEST_TEMPLATE

「絶対に行きたい場所:」フィールドに注記を追加：

```
変更前:
- 絶対に行きたい場所:

変更後:
- 絶対に行きたい場所（必ず全て含まれます）:
```

## TDD 手順

1. `generatePrompt.test.ts` に新しい期待文言のテストを追加（先にfail）
2. `generatePrompt.ts` のプロンプトテキストを修正（テストをpass）
3. `PromptForm.tsx` の REQUEST_TEMPLATE を修正
4. 全テスト実行で確認

## 実装結果

- テスト: 92 passed / 19 test files（全グリーン）
- 注意点: `generatePrompt.ts` 編集時にルール12（`全角・スマートクォート（" " '）は使用禁止`）の全角引用符がASCII文字に化けるエラーが発生。Pythonスクリプトで Unicode エスケープ（`\u201d` `\u201c` `\u2019`）を使って修正した。

## 検証コマンド

```bash
docker compose run --rm app npx vitest run
```
