# Plan: プロンプト文改善 — 移動効率と訪問地の厳守

## Context

しおりアプリのプロンプト生成において、現状のLLMへの指示が「行きたい場所を反映する」程度の曖昧な表現にとどまっていた。これにより：
- 「絶対に行きたい場所」がスケジュールに含まれないケースがある
- 各スポットの地理的位置を考慮せず、移動が非効率なルートになる
- 店名・施設名が不明確でも確認なしに出力される
- 営業時間を無視したスケジューリングになる場合がある

## 変更ファイル

### 1. `src/application/usecases/generatePrompt.ts`

プロンプト冒頭の役割説明を強化：

```
変更前:
あなたは旅行プランナーです。以下の条件で旅行しおりデータを作成してください。

変更後:
あなたは地理情報を熟知した旅行プランナーです。以下の条件で旅行しおりデータを作成してください。
「絶対に行きたい場所」は必ずすべてスケジュールに組み込み、スポット間の地理的な位置関係を考慮して移動効率の高いルートを組んでください。
```

出力ルール（旧 rule 7 を分割・強化し、旧 8〜11 を 12〜15 に繰り下げ）：

- **rule 7**: 「絶対に行きたい場所」を全て items に含める（1か所でも欠落したら出力無効）
- **rule 8**: 地理的に近いスポットを隣接時間枠にまとめ、バックトラック禁止
- **rule 9**: 長距離移動は「移動」item として明示し手段・所要時間を記載
- **rule 10**: 店名・施設名が不明確な場合は description に「※ 要確認」を明記
- **rule 11**: 営業時間・開館時間を考慮してスケジューリング。制限がある場合は description に目安を記載

### 2. `src/application/usecases/generatePrompt.test.ts`

新ルール6件に対応するテストを追加：
- 役割説明（地理情報を熟知）の文言確認
- 訪問地厳守ルール文言の確認
- バックトラック回避の文言確認
- 長距離移動の明示ルール確認
- 店名要確認の文言確認
- 営業時間考慮の文言確認

### 3. `src/presentation/components/PromptForm.tsx`

```
変更前: - 絶対に行きたい場所:
変更後: - 絶対に行きたい場所（必ず全て含まれます）:
```

## 実装結果

- テスト: 66 passed / 15 test files（全グリーン）
- 注意点: Edit ツール使用時に全角引用符（`" " '`）が ASCII に化けるため、Python の Unicode エスケープ（`\u201d` `\u201c` `\u2019`）で修正が必要。

## 検証コマンド

```bash
docker compose run --rm app npx vitest run
```
